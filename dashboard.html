<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perabot Megah - Dashboard</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/dashboard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body data-theme="dark">
  <!-- Toast Container for Floating Notifications -->
  <div id="toastContainer" class="toast-container"></div>
  
  <div class="container">
    <!-- Theme Toggle Button - Outside Header -->
    <div class="theme-toggle-container">
      <button id="themeToggle" class="btn btn-outline btn-sm theme-toggle" onclick="toggleTheme()">
        <i class="icon icon-lightbulb" id="themeIcon"></i>
        <span id="themeText">Light Mode</span>
      </button>
    </div>
    
    <header class="page-header">
      <h1 class="page-title">
        Perabot Megah - Dashboard
      </h1>
    </header>
    
    <main class="main-content">
      <!-- Standalone Refresh All Button -->
      <div class="standalone-refresh">
        <button class="btn btn-outline btn-sm" onclick="refreshAllSections()">
          <i class="icon icon-sync icon-margin-right"></i>
          Refresh All Data
        </button>
      </div>
      
      <!-- Section 1: Overview -->
      <section class="dashboard-section" id="overviewSection">
        <div class="section-header">
          <h2 class="section-title">
            <i class="icon icon-dashboard icon-margin-right"></i>
            Overview
          </h2>
          <div class="section-actions">
            <button class="btn btn-outline btn-sm" onclick="refreshOverviewData()">
              <i class="icon icon-refresh icon-margin-right"></i>
              Refresh
            </button>
          </div>
        </div>
        
        <!-- KPI Cards -->
        <div class="kpi-cards">
          <div class="kpi-card" id="totalSalesTodayCard">
            <div class="kpi-icon">
              <i class="icon icon-trending-up"></i>
            </div>
            <div class="kpi-content">
              <div class="kpi-value" id="totalSalesToday">--</div>
              <div class="kpi-label">Total Sales Today (RM)</div>
            </div>
          </div>
          
          <div class="kpi-card" id="unitsSoldTodayCard">
            <div class="kpi-icon">
              <i class="icon icon-shopping-cart"></i>
            </div>
            <div class="kpi-content">
              <div class="kpi-value" id="unitsSoldToday">--</div>
              <div class="kpi-label">Units Sold Today</div>
            </div>
          </div>
          
          <div class="kpi-card" id="totalInventoryValueCard">
            <div class="kpi-icon">
              <i class="icon icon-account-balance-wallet"></i>
            </div>
            <div class="kpi-content">
              <div class="kpi-value" id="totalInventoryValue">--</div>
              <div class="kpi-label">Total Inventory Value (RM)</div>
            </div>
          </div>
          
          <div class="kpi-card" id="outOfStockCard">
            <div class="kpi-icon">
              <i class="icon icon-warning"></i>
            </div>
            <div class="kpi-content">
              <div class="kpi-value" id="outOfStockCount">--</div>
              <div class="kpi-label">Out-of-Stock SKUs</div>
            </div>
          </div>
        </div>
        
        <!-- Top 10 SKU Performance Chart -->
        <div class="chart-section">
          <div class="chart-header">
            <h3 class="chart-title">Top 10 SKU Performance</h3>
            <div class="chart-controls">
              <button class="btn btn-pill active" id="trend7Days" onclick="switchTrendPeriod(7)">
                7 Days
              </button>
              <button class="btn btn-pill" id="trend30Days" onclick="switchTrendPeriod(30)">
                30 Days
              </button>
            </div>
          </div>
          <div class="chart-container" id="topSkuPerformanceChartContainer">
            <canvas id="topSkuPerformanceChart"></canvas>
          </div>
        </div>
      </section>
      
      <!-- Section 2: Shop Information -->
      <section class="dashboard-section" id="shopInfoSection">
        <div class="section-header">
          <h2 class="section-title">
            <i class="icon icon-store icon-margin-right"></i>
            Shop Information
          </h2>
          <div class="section-actions">
            <button class="btn btn-outline btn-sm" onclick="refreshShopInfo()">
              <i class="icon icon-refresh icon-margin-right"></i>
              Refresh
            </button>
          </div>
        </div>
        
        <div class="shop-info-grid">
          <!-- Top 5 Selling SKUs Today -->
          <div class="chart-section">
            <div class="chart-header">
              <h3 class="chart-title">Top 5 Selling SKUs Today</h3>
              <div class="chart-legend">
                <span class="legend-item">
                  <span class="legend-color" style="background: #3b82f6;"></span>
                  Category 6 = Other
                </span>
              </div>
            </div>
            <div class="chart-summary" id="topSellingSummary">
              <div class="summary-item">
                <span class="summary-label">Total Units Sold:</span>
                <span class="summary-value" id="totalUnitsSold">--</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Top SKU:</span>
                <span class="summary-value" id="topSku">--</span>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="topSellingChart"></canvas>
            </div>
          </div>
          
          <!-- Cumulative Sales by SKU -->
          <div class="chart-section">
            <div class="chart-header">
              <h3 class="chart-title">Cumulative Sales by SKU</h3>
              <div class="chart-controls">
                <button class="btn btn-pill active" id="cumulative7Days" onclick="switchCumulativePeriod(7)">
                  7 Days
                </button>
                <button class="btn btn-pill" id="cumulative30Days" onclick="switchCumulativePeriod(30)">
                  30 Days
                </button>
              </div>
            </div>
            <div class="table-container">
              <table class="cumulative-sales-table" id="cumulativeSalesTable">
                <thead>
                  <tr>
                    <th>SKU</th>
                    <th>Product Name</th>
                    <th>Total Units Sold</th>
                    <th>Total Sales Value</th>
                  </tr>
                </thead>
                <tbody id="cumulativeSalesTableBody">
                  <tr class="empty-row">
                    <td colspan="4">No sales data available</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Shop Inventory + Low Stock Alerts -->
          <div class="chart-section">
            <div class="chart-header">
              <h3 class="chart-title">Shop Inventory + Low Stock Alerts</h3>
              <div class="chart-legend">
                <span class="legend-item">
                  <span class="legend-color" style="background: var(--color-success);"></span>
                  Healthy
                </span>
                <span class="legend-item">
                  <span class="legend-color" style="background: var(--color-warning);"></span>
                  Low Stock
                </span>
                <span class="legend-item">
                  <span class="legend-color" style="background: var(--color-error);"></span>
                  Out of Stock
                </span>
              </div>
            </div>
            <div class="table-container">
              <table class="inventory-alerts-table" id="inventoryAlertsTable">
                <thead>
                  <tr>
                    <th>SKU</th>
                    <th>Product Name</th>
                    <th>Current Stock</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="inventoryAlertsTableBody">
                  <tr class="empty-row">
                    <td colspan="4">No inventory data available</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Section 3: Warehouse -->
      <section class="dashboard-section" id="warehouseSection">
        <div class="section-header">
          <h2 class="section-title">
            <i class="icon icon-warehouse icon-margin-right"></i>
            Warehouse
          </h2>
          <div class="section-actions">
            <button class="btn btn-outline btn-sm" onclick="refreshWarehouseData()">
              <i class="icon icon-refresh icon-margin-right"></i>
              Refresh
            </button>
          </div>
        </div>
        
        <div class="warehouse-content">
          <!-- Warehouse Inventory + Low Stock Alerts -->
          <div class="chart-section">
            <div class="chart-header">
              <h3 class="chart-title">Warehouse Inventory + Low Stock Alerts</h3>
              <div class="chart-legend">
                <span class="legend-item">
                  <span class="legend-color" style="background: var(--color-success);"></span>
                  Healthy
                </span>
                <span class="legend-item">
                  <span class="legend-color" style="background: var(--color-warning);"></span>
                  Low Stock
                </span>
                <span class="legend-item">
                  <span class="legend-color" style="background: var(--color-error);"></span>
                  Out of Stock
                </span>
              </div>
            </div>
            <div class="table-container">
              <table class="warehouse-inventory-table" id="warehouseInventoryTable">
                <thead>
                  <tr>
                    <th>SKU</th>
                    <th>Product Name</th>
                    <th>Current Stock</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="warehouseInventoryTableBody">
                  <tr class="empty-row">
                    <td colspan="4">No warehouse inventory data available</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          

        </div>
              </section>
        
        <!-- Section 4: Dead Stock (No Sales in 14+ Days) -->
        <section class="dashboard-section" id="deadStockSection">
          <div class="section-header">
            <h2 class="section-title">
              <i class="icon icon-inventory icon-margin-right"></i>
              Dead Stock (No Sales in 14+ Days)
            </h2>
            <div class="section-actions">
              <button class="btn btn-outline btn-sm" onclick="refreshDeadStockData()">
                <i class="icon icon-refresh icon-margin-right"></i>
                Refresh
              </button>
            </div>
          </div>
          
          <div class="dead-stock-content">
            <!-- Dead Stock Table -->
            <div class="chart-section">
              <div class="chart-header">
                <h3 class="chart-title">Dead Stock Analysis</h3>
                <p class="chart-subtitle">Items with no sales activity in the last 14+ days</p>
              </div>
              
              <div class="table-container">
                <table class="dead-stock-table" id="deadStockTable">
                  <thead>
                    <tr>
                      <th>SKU</th>
                      <th>Product Name</th>
                      <th>Current Stock</th>
                      <th>Days Since Last Sale</th>
                      <th>Stock Value (RM)</th>
                    </tr>
                  </thead>
                  <tbody id="deadStockTableBody">
                    <tr class="empty-row">
                      <td colspan="5">Loading dead stock data...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            

          </div>
        </section>
      </main>
    </div>

  <script>
    // ====== Configuration ======
    // 
    // SALES VALUE CALCULATION SOLUTION:
    // The dashboard calculates sales values in real-time using:
    // 1. TodaySales (quantity) from Sales Snapshot
    // 2. Product Price from Product Master
    // 3. Real-time calculation: Sales Value = Quantity Ã— Price
    // 
    // This approach is lightweight and doesn't require:
    // - Additional Google Sheet columns
    // - Backend code changes
    // - Additional API calls
    // 
    const apiBase = "https://script.google.com/macros/s/AKfycbxWJtUf1RbkfZ5WYzduPCenebrqAbBAw20XbzCLtjs4FXH7k9Gsuyrpu4zm1Ycu2iG0/exec";
    
    // ====== Toast Notification System ======
    
    // Centralized toast function that automatically handles all message types
    function showToast(type, title, message, duration = 5000) {
      const toastContainer = document.getElementById('toastContainer');
      
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      
      // Build a dedupe key from type+title+message
      const key = `${type}|${title}|${message}`;
      toast.setAttribute('data-toast-key', key);
      
      // If a toast with the same key already exists, reuse it (no duplicate)
      const existing = toastContainer.querySelector(`.toast[data-toast-key="${CSS.escape(key)}"]`);
      if (existing) {
        return existing;
      }
      
      // Get appropriate icon for type
      let iconClass = 'icon-info';
      switch(type) {
        case 'success': iconClass = 'icon-check-circle'; break;
        case 'error': iconClass = 'icon-error'; break;
        case 'warning': iconClass = 'icon-warning'; break;
        case 'info': iconClass = 'icon-info'; break;
      }
      
      toast.innerHTML = `
        <i class="icon ${iconClass} toast-icon"></i>
        <div class="toast-content">
          <span class="toast-message">${message}</span>
        </div>
      `;
      
      // Cap number of toasts to 3 (remove the oldest first)
      while (toastContainer.children.length >= 3) {
        toastContainer.removeChild(toastContainer.firstElementChild);
      }
      
      // Add to container
      toastContainer.appendChild(toast);
      
      // Trigger show animation with smooth fadeIn and translateY
      setTimeout(() => toast.classList.add('show'), 10);
      
      // Auto-hide after duration with smooth fadeOut and translateY
      if (duration > 0) {
        setTimeout(() => {
          toast.classList.add('hide');
          setTimeout(() => {
            if (toast.parentElement) {
              toast.remove();
            }
          }, 300); // Increased to match smooth animation
        }, duration);
      }
      
      return toast;
    }
    
    // Simple convenience functions that only show toasts (no result div updates)
    function showSuccess(message, duration = 5000) {
      return showToast('success', '', message, duration);
    }
    
    function showError(message, duration = 5000) {
      return showToast('error', '', message, duration);
    }
    
    function showWarning(message, duration = 5000) {
      return showToast('warning', '', message, duration);
    }
    
    function showInfo(message, duration = 5000) {
      return showToast('info', '', message, duration);
    }

    // ====== Data Fetching Functions ======
    
    // Global data storage
    let dashboardData = {
      inventorySnapshot: null,
      salesSnapshot: null,
      products: null,
      lastUpdated: null
    };
    
    // Fetch inventory snapshot data
    async function fetchInventorySnapshot() {
      try {
        showInfo('Loading inventory data...');
        
        const response = await fetch(apiBase + "?action=getInventorySnapshot");
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        if (data.status === "success" && data.data) {
          // Handle both empty data and populated data
          if (data.data.length === 0) {
            // Empty inventory - initialize with empty array
            dashboardData.inventorySnapshot = [];
            dashboardData.lastUpdated = new Date();
            showInfo('No inventory data yet - starting fresh');
            console.log('Inventory snapshot loaded: Empty (no inventory data yet)');
            return [];
          } else {
            dashboardData.inventorySnapshot = data.data;
            dashboardData.lastUpdated = new Date();
            showSuccess('Inventory data loaded successfully');
            console.log('Inventory snapshot loaded:', data.data);
            return data.data;
          }
        } else {
          throw new Error(data.message || 'Failed to load inventory data');
        }
      } catch (error) {
        showError(`Failed to load inventory: ${error.message}`);
        console.error('Error fetching inventory snapshot:', error);
        return null;
      }
    }
    
    // Fetch sales snapshot data
    async function fetchSalesSnapshot() {
      try {
        showInfo('Loading sales data...');
        
        // Note: Sales snapshot endpoint not yet implemented in GAS
        // This is a placeholder for when it's added
        const response = await fetch(apiBase + "?action=getSalesSnapshot");
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        if (data.status === "success" && data.data) {
          // Handle both empty data and populated data
          if (data.data.length === 0) {
            // Empty sales - initialize with empty array
            dashboardData.salesSnapshot = [];
            dashboardData.lastUpdated = new Date();
            showInfo('No sales data yet - starting fresh');
            console.log('Sales snapshot loaded: Empty (no sales data yet)');
            return [];
          } else {
            dashboardData.salesSnapshot = data.data;
            dashboardData.lastUpdated = new Date();
            showSuccess('Sales data loaded successfully');
            console.log('Sales snapshot loaded:', data.data);
            return data.data;
          }
        } else {
          throw new Error(data.message || 'Failed to load sales data');
        }
      } catch (error) {
        // For now, just log the error since endpoint might not exist yet
        console.log('Sales snapshot endpoint not yet implemented:', error.message);
        return null;
      }
    }
    
    // Fetch product master data
    async function fetchProducts() {
      try {
        showInfo('Loading product data...');
        
        const response = await fetch(apiBase + "?action=getProducts");
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        if (data.status === "success" && data.data && data.data.length > 0) {
          dashboardData.products = data.data;
          dashboardData.lastUpdated = new Date();
          showSuccess(`Loaded ${data.data.length} products`);
          console.log('Products loaded:', data.data);
          return data.data;
        } else {
          throw new Error(data.message || 'No products available');
        }
      } catch (error) {
        showError(`Failed to load products: ${error.message}`);
        console.error('Error fetching products:', error);
        return null;
      }
    }
    
    // Fetch all dashboard data
    async function fetchAllDashboardData() {
      try {
        showInfo('Loading dashboard data...');
        showKPILoading();
        
        // Fetch data in parallel for better performance
        const [inventoryData, productsData] = await Promise.all([
          fetchInventorySnapshot(),
          fetchProducts()
        ]);
        
        // Sales data is optional for now
        const salesData = await fetchSalesSnapshot();
        
        // Products are required, inventory and sales can be empty initially
        if (productsData) {
          if (inventoryData !== null) {
            showSuccess('Dashboard data loaded successfully');
          } else {
            showWarning('Dashboard loaded with limited data - some features may not work');
          }
          
          console.log('All dashboard data loaded:', dashboardData);
          
          // Hide loading and calculate KPIs (will show 0 values for empty data)
          hideKPILoading();
          calculateOverviewKPIs();
          
          // Update shop information charts
          updateTopSellingChart();
          updateCumulativeSalesTable();
          updateInventoryAlertsTable();
          updateWarehouseInventoryTable();
          updateDeadStockTable();
          
          return true;
        } else {
          throw new Error('Failed to load essential dashboard data');
        }
      } catch (error) {
        showError(`Failed to load dashboard data: ${error.message}`);
        console.error('Error loading dashboard data:', error);
        hideKPILoading();
        return false;
      }
    }
    
    // Test API connection
    async function testAPIConnection() {
      try {
        showInfo('Testing API connection...');
        
        const response = await fetch(apiBase + "?action=testSheets");
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        if (data.status === "success") {
          showSuccess('API connection successful');
          console.log('API test results:', data.results);
          return data.results;
        } else {
          throw new Error(data.message || 'API test failed');
        }
      } catch (error) {
        showError(`API connection failed: ${error.message}`);
        console.error('API connection test failed:', error);
        return null;
      }
    }
    
    // Refresh dashboard data
    async function refreshDashboardData() {
      dashboardData.lastUpdated = new Date();
      return await fetchAllDashboardData();
    }
    
    // Calculate sales value from quantity and product price
    function calculateSalesValue(quantity, sku, products) {
      // Input validation
      if (!quantity || quantity <= 0) {
        console.log(`Invalid quantity for SKU ${sku}: ${quantity}`);
        return 0;
      }
      
      if (!sku || typeof sku !== 'string') {
        console.warn(`Invalid SKU: ${sku}`);
        return 0;
      }
      
      if (!products || products.length === 0) {
        console.warn('No products available for price lookup');
        return 0;
      }
      
      const product = products.find(p => p.SKU === sku);
      if (!product) {
        console.warn(`Product not found for SKU: ${sku}`);
        return 0;
      }
      
      const price = parseFloat(product.Price) || 0;
      if (price <= 0) {
        console.warn(`Invalid price for SKU ${sku}: RM${price}`);
        return 0;
      }
      
      const saleValue = quantity * price;
      
      console.log(`SKU: ${sku}, Quantity: ${quantity}, Price: RM${price}, Sale Value: RM${saleValue.toFixed(2)}`);
      return saleValue;
    }
    
    // Get data summary for dashboard
    function getDashboardDataSummary() {
      const summary = {
        totalProducts: dashboardData.products ? dashboardData.products.length : 0,
        totalInventoryItems: dashboardData.inventorySnapshot ? dashboardData.inventorySnapshot.length : 0, // No headers in new format
        lastUpdated: dashboardData.lastUpdated,
        hasSalesData: !!dashboardData.salesSnapshot
      };
      
      if (dashboardData.inventorySnapshot && dashboardData.inventorySnapshot.length > 0) {
        // New format: data is array of objects with named properties
        let totalStock = 0;
        let shopStock = 0;
        let warehouseStock = 0;
        let lowStockItems = 0;
        let outOfStockItems = 0;
        let totalInventoryValue = 0;
        
        dashboardData.inventorySnapshot.forEach(row => {
          const stock = parseInt(row.CurrentStock, 10) || 0;
          const location = row.Location;
          const inventoryValue = parseFloat(row.InventoryValue) || 0;
          
          totalStock += stock;
          totalInventoryValue += inventoryValue;
          
          if (location === 'Shop') {
            shopStock += stock;
          } else if (location === 'Warehouse') {
            warehouseStock += stock;
          }
          
          if (stock <= 0) {
            outOfStockItems++;
          } else if (stock < 20) {
            lowStockItems++;
          }
        });
        
        summary.totalStock = totalStock;
        summary.shopStock = shopStock;
        summary.warehouseStock = warehouseStock;
        summary.lowStockItems = lowStockItems;
        summary.outOfStockItems = outOfStockItems;
        summary.totalInventoryValue = totalInventoryValue;
      }
      
      return summary;
    }

    // ====== Overview Section Functions ======
    
    // Global chart instances
    let topSkuPerformanceChart = null;
    let topSellingChart = null;
    let currentTrendPeriod = 7; // Default to 7 days
    let currentCumulativePeriod = 7; // Default to 7 days
    
    // Calculate overview KPIs
    function calculateOverviewKPIs() {
      const summary = getDashboardDataSummary();
      
      // Calculate sales KPIs from sales snapshot with proper monetary calculations
      let totalSalesValueToday = 0;
      let unitsSoldToday = 0;
      
      if (dashboardData.salesSnapshot && dashboardData.salesSnapshot.length > 0 && dashboardData.products) {
        console.log('Processing sales snapshot data:', dashboardData.salesSnapshot);
        console.log('Available products for price lookup:', dashboardData.products.length);
        
        dashboardData.salesSnapshot.forEach(sale => {
          console.log('Processing sale record:', sale);
          const quantity = sale.TodaySales || 0;
          const sku = sale.SKU;
          
          // Calculate sales value using helper function
          const saleValue = calculateSalesValue(quantity, sku, dashboardData.products);
          totalSalesValueToday += saleValue;
          unitsSoldToday += quantity;
        });
        
        console.log('Calculated totals - Sales Value:', totalSalesValueToday.toFixed(2), 'Units:', unitsSoldToday);
      } else {
        console.log('No sales data or products available - showing 0 values');
      }
      
      // Check if we have any data to display
      const hasAnyData = (dashboardData.inventorySnapshot && dashboardData.inventorySnapshot.length > 0) || 
                         (dashboardData.salesSnapshot && dashboardData.salesSnapshot.length > 0);
      
      if (!hasAnyData) {
        // No data available - show warning state
        showKPINoData();
        console.log('No data available - KPI cards showing warning state');
      } else if (!dashboardData.products || dashboardData.products.length === 0) {
        // No products available - show warning for sales calculations
        showWarning('Product data unavailable - sales values may be inaccurate');
        console.log('No products available - sales calculations may be incomplete');
      } else {
        // Update KPI cards with visual feedback
        updateKPICard('totalSalesToday', totalSalesValueToday > 0 ? `RM ${totalSalesValueToday.toFixed(2)}` : 'RM 0.00', totalSalesValueToday > 0 ? 'success' : 'warning');
        updateKPICard('unitsSoldToday', unitsSoldToday > 0 ? unitsSoldToday.toString() : '0', unitsSoldToday > 0 ? 'success' : 'warning');
        updateKPICard('totalInventoryValue', summary.totalInventoryValue > 0 ? `RM ${summary.totalInventoryValue.toFixed(2)}` : 'RM 0.00', summary.totalInventoryValue > 0 ? 'success' : 'warning');
        updateKPICard('outOfStockCount', summary.outOfStockItems > 0 ? summary.outOfStockItems.toString() : '0', summary.outOfStockItems > 0 ? 'error' : 'success');
      }
      
      // Update chart data
      updateTopSkuPerformanceChart();
    }
    
    // Update individual KPI card with visual state
    function updateKPICard(elementId, value, state) {
      const element = document.getElementById(elementId);
      const card = element.closest('.kpi-card');
      
      if (element && card) {
        // Remove previous state classes
        card.classList.remove('loading', 'success', 'warning', 'error');
        
        // Add new state class
        card.classList.add(state);
        
        // Update value with animation
        element.style.opacity = '0.5';
        element.textContent = value;
        
        // Fade in the new value
        setTimeout(() => {
          element.style.opacity = '1';
        }, 150);
      }
    }
    
    // Show loading state for KPI cards
    function showKPILoading() {
      const kpiCards = document.querySelectorAll('.kpi-card');
      kpiCards.forEach(card => {
        card.classList.add('loading');
        const valueElement = card.querySelector('.kpi-value');
        if (valueElement) {
          valueElement.textContent = 'Loading...';
        }
      });
    }
    
    // Show warning state for KPI cards when no data
    function showKPINoData() {
      const kpiCards = document.querySelectorAll('.kpi-card');
      kpiCards.forEach(card => {
        card.classList.remove('loading');
        card.classList.add('warning');
        const valueElement = card.querySelector('.kpi-value');
        if (valueElement) {
          valueElement.textContent = 'No Data';
        }
      });
    }
    
    // Hide loading state for KPI cards
    function hideKPILoading() {
      const kpiCards = document.querySelectorAll('.kpi-card');
      kpiCards.forEach(card => {
        card.classList.remove('loading');
      });
    }
    
    // Update Top 5 Selling SKUs Today chart
    function updateTopSellingChart() {
      const chartSection = document.querySelector('#topSellingChart').closest('.chart-section');
      
      if (!dashboardData.salesSnapshot || dashboardData.salesSnapshot.length === 0) {
        console.log('No sales data available - top selling chart will show empty data');
        chartSection.classList.add('empty');
        return;
      }
      
      // Sort sales by TodaySales (quantity) and get top 5
      const topSelling = dashboardData.salesSnapshot
        .filter(sale => sale.TodaySales && sale.TodaySales > 0)
        .sort((a, b) => (b.TodaySales || 0) - (a.TodaySales || 0))
        .slice(0, 5);
      
      if (topSelling.length === 0) {
        console.log('No sales today - top selling chart will show empty data');
        chartSection.classList.add('empty');
        return;
      }
      
      // Remove empty state
      chartSection.classList.remove('empty');
      
      // Update summary information
      const totalUnits = topSelling.reduce((sum, sale) => sum + (sale.TodaySales || 0), 0);
      const topSku = topSelling[0]?.SKU || '--';
      
      document.getElementById('totalUnitsSold').textContent = totalUnits;
      document.getElementById('topSku').textContent = topSku;
      
      const chartData = {
        labels: topSelling.map(sale => `${sale.SKU} (${sale.TodaySales})`),
        datasets: [{
          data: topSelling.map(sale => sale.TodaySales || 0),
          backgroundColor: [
            '#3b82f6', // Blue
            '#10b981', // Green
            '#f59e0b', // Yellow
            '#ef4444', // Red
            '#8b5cf6'  // Purple
          ],
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      };
      
      if (topSellingChart) {
        topSellingChart.destroy();
      }
      
      const ctx = document.getElementById('topSellingChart').getContext('2d');
      topSellingChart = new Chart(ctx, {
        type: 'doughnut',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false // We have custom legend above
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  return `${label}: ${value} units`;
                }
              }
            }
          },
          cutout: '60%'
        }
      });
      
      console.log('Top selling chart updated with data:', topSelling);
    }
    
    // Update Cumulative Sales by SKU table
    function updateCumulativeSalesTable() {
      const tableSection = document.querySelector('#cumulativeSalesTable').closest('.chart-section');
      
      if (!dashboardData.salesSnapshot || dashboardData.salesSnapshot.length === 0) {
        console.log('No sales data available - cumulative sales table will show empty data');
        showEmptyTable();
        return;
      }
      
      // Get cumulative sales data for the selected period
      const cumulativeData = prepareCumulativeTableData(currentCumulativePeriod);
      
      if (cumulativeData.length === 0) {
        console.log('No cumulative data available - table will show empty data');
        showEmptyTable();
        return;
      }
      
      // Populate table with data
      populateCumulativeSalesTable(cumulativeData);
      console.log('Cumulative sales table updated with data:', cumulativeData);
    }
    
    // Prepare cumulative table data based on period
    function prepareCumulativeTableData(period) {
      const tableData = [];
      
      if (dashboardData.salesSnapshot && dashboardData.salesSnapshot.length > 0 && dashboardData.products) {
        // Calculate cumulative sales for each SKU
        const skuData = {};
        
        dashboardData.salesSnapshot.forEach(sale => {
          const sku = sale.SKU;
          const quantity = sale.TodaySales || 0;
          
          if (!skuData[sku]) {
            skuData[sku] = {
              sku: sku,
              unitsSold: 0,
              salesValue: 0,
              productName: 'Unknown Product'
            };
          }
          
          // Calculate sales value using helper function
          const saleValue = calculateSalesValue(quantity, sku, dashboardData.products);
          skuData[sku].unitsSold += quantity;
          skuData[sku].salesValue += saleValue;
          
          // Get product name from product master
          const product = dashboardData.products.find(p => p.SKU === sku);
          if (product && product["Product Name"]) {
            skuData[sku].productName = product["Product Name"];
          }
        });
        
        // Convert to array and sort by sales value (descending) - highest sales first
        const sortedSKUs = Object.values(skuData)
          .filter(item => item.salesValue > 0)
          .sort((a, b) => b.salesValue - a.salesValue);
        
        console.log('Cumulative table data prepared:', sortedSKUs);
        return sortedSKUs;
      }
      
      return [];
    }
    
    // Populate cumulative sales table with data
    function populateCumulativeSalesTable(data) {
      const tableBody = document.getElementById('cumulativeSalesTableBody');
      
      if (!tableBody) {
        console.error('Table body element not found');
        return;
      }
      
      // Clear existing rows
      tableBody.innerHTML = '';
      
      // Add data rows
      data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="sku-column">${item.sku}</td>
          <td class="product-name-column" title="${item.productName}">${item.productName}</td>
          <td class="units-column">${item.unitsSold}</td>
          <td class="value-column">RM ${item.salesValue.toFixed(2)}</td>
        `;
        tableBody.appendChild(row);
      });
    }
    
    // Show empty table state
    function showEmptyTable() {
      const tableBody = document.getElementById('cumulativeSalesTableBody');
      
      if (tableBody) {
        tableBody.innerHTML = '<tr class="empty-row"><td colspan="4">No sales data available</td></tr>';
      }
    }
    
    // Update Inventory Alerts Table
    function updateInventoryAlertsTable() {
      if (!dashboardData.inventorySnapshot || dashboardData.inventorySnapshot.length === 0) {
        console.log('No inventory data available - inventory alerts table will show empty data');
        showEmptyInventoryTable();
        return;
      }
      
      // Get inventory data with product names and sales data
      const inventoryData = prepareInventoryAlertsData();
      
      if (inventoryData.length === 0) {
        console.log('No inventory data available - table will show empty data');
        showEmptyInventoryTable();
        return;
      }
      
      // Populate table with data
      populateInventoryAlertsTable(inventoryData);
      console.log('Inventory alerts table updated with data:', inventoryData);
    }
    
    // Prepare inventory alerts data
    function prepareInventoryAlertsData() {
      const tableData = [];
      
      if (dashboardData.inventorySnapshot && dashboardData.inventorySnapshot.length > 0 && dashboardData.products) {
        dashboardData.inventorySnapshot.forEach(inventory => {
          // Filter to show only shop inventory (SnapshotID ends with 'shop')
          const snapshotId = inventory.SnapshotID || '';
          if (!snapshotId.toLowerCase().endsWith('shop')) {
            return; // Skip warehouse inventory
          }
          
          const sku = inventory.SKU;
          const currentStock = parseInt(inventory.CurrentStock, 10) || 0;
          const stockStatus = inventory.StockStatus || 'Unknown';
          
          // Get product name from product master
          const product = dashboardData.products.find(p => p.SKU === sku);
          const productName = product && product["Product Name"] ? product["Product Name"] : 'Unknown Product';
          
          tableData.push({
            sku: sku,
            productName: productName,
            currentStock: currentStock,
            stockStatus: stockStatus
          });
        });
        
        // Sort by stock level (lowest first) - most critical items at top
        tableData.sort((a, b) => {
          // First sort by stock level (ascending - lowest stock first)
          if (a.currentStock !== b.currentStock) {
            return a.currentStock - b.currentStock;
          }
          // If same stock level, sort by SKU alphabetically
          return a.sku.localeCompare(b.sku);
        });
        
        console.log('Inventory alerts data prepared:', tableData);
        return tableData;
      }
      
      return [];
    }
    
    // Populate inventory alerts table with data
    function populateInventoryAlertsTable(data) {
      const tableBody = document.getElementById('inventoryAlertsTableBody');
      
      if (!tableBody) {
        console.error('Inventory alerts table body element not found');
        return;
      }
      
      // Clear existing rows
      tableBody.innerHTML = '';
      
      // Add data rows
      data.forEach(item => {
        const row = document.createElement('tr');
        const statusClass = getStatusClass(item.stockStatus);
        
        row.className = statusClass;
        row.innerHTML = `
          <td class="sku-column">${item.sku}</td>
          <td class="product-name-column" title="${item.productName}">${item.productName}</td>
          <td class="stock-column">${item.currentStock}</td>
          <td class="status-dot-column"></td>
        `;
        tableBody.appendChild(row);
      });
    }
    
    // Get CSS class for stock status
    function getStatusClass(stockStatus) {
      switch (stockStatus) {
        case 'Red':
          return 'status-out-of-stock';
        case 'Yellow':
          return 'status-low-stock';
        case 'Green':
          return 'status-healthy';
        default:
          return '';
      }
    }
    
    // Show empty inventory table state
    function showEmptyInventoryTable() {
      const tableBody = document.getElementById('inventoryAlertsTableBody');
      
      if (tableBody) {
        tableBody.innerHTML = '<tr class="empty-row"><td colspan="5">No inventory data available</td></tr>';
      }
    }
    
    // Update Warehouse Inventory Table
    function updateWarehouseInventoryTable() {
      if (!dashboardData.inventorySnapshot || dashboardData.inventorySnapshot.length === 0) {
        console.log('No inventory data available - warehouse inventory table will show empty data');
        showEmptyWarehouseTable();
        return;
      }
      
      // Get warehouse inventory data with product names
      const warehouseData = prepareWarehouseInventoryData();
      
      if (warehouseData.length === 0) {
        console.log('No warehouse data available - table will show empty data');
        showEmptyWarehouseTable();
        return;
      }
      
      // Populate table with data
      populateWarehouseInventoryTable(warehouseData);
      console.log('Warehouse inventory table updated with data:', warehouseData);
    }
    
    // Prepare warehouse inventory data
    function prepareWarehouseInventoryData() {
      const tableData = [];
      
      if (dashboardData.inventorySnapshot && dashboardData.inventorySnapshot.length > 0 && dashboardData.products) {
        dashboardData.inventorySnapshot.forEach(inventory => {
          // Filter to show only warehouse inventory (SnapshotID ends with 'warehouse')
          const snapshotId = inventory.SnapshotID || '';
          if (!snapshotId.toLowerCase().endsWith('warehouse')) {
            return; // Skip shop inventory
          }
          
          const sku = inventory.SKU;
          const currentStock = parseInt(inventory.CurrentStock, 10) || 0;
          const stockStatus = inventory.StockStatus || 'Unknown';
          
          // Get product name from product master
          const product = dashboardData.products.find(p => p.SKU === sku);
          const productName = product && product["Product Name"] ? product["Product Name"] : 'Unknown Product';
          
          tableData.push({
            sku: sku,
            productName: productName,
            currentStock: currentStock,
            stockStatus: stockStatus
          });
        });
        
        // Sort by stock level (lowest first) - most critical items at top
        tableData.sort((a, b) => {
          // First sort by stock level (ascending - lowest stock first)
          if (a.currentStock !== b.currentStock) {
            return a.currentStock - b.currentStock;
          }
          // If same stock level, sort by SKU alphabetically
          return a.sku.localeCompare(b.sku);
        });
        
        console.log('Warehouse inventory data prepared:', tableData);
        return tableData;
      }
      
      return [];
    }
    
    // Populate warehouse inventory table with data
    function populateWarehouseInventoryTable(data) {
      const tableBody = document.getElementById('warehouseInventoryTableBody');
      
      if (!tableBody) {
        console.error('Warehouse inventory table body element not found');
        return;
      }
      
      // Clear existing rows
      tableBody.innerHTML = '';
      
      // Add data rows
      data.forEach(item => {
        const row = document.createElement('tr');
        const statusClass = getStatusClass(item.stockStatus);
        
        row.className = statusClass;
        row.innerHTML = `
          <td class="sku-column">${item.sku}</td>
          <td class="product-name-column" title="${item.productName}">${item.productName}</td>
          <td class="stock-column">${item.currentStock}</td>
          <td></td>
        `;
        tableBody.appendChild(row);
      });
    }
    
    // Show empty warehouse table state
    function showEmptyWarehouseTable() {
      const tableBody = document.getElementById('warehouseInventoryTableBody');
      
      if (tableBody) {
        tableBody.innerHTML = '<tr class="empty-row"><td colspan="4">No warehouse inventory data available</td></tr>';
      }
    }
    

    
    // Switch cumulative period
    function switchCumulativePeriod(period) {
      currentCumulativePeriod = period;
      
      // Update button states
      document.getElementById('cumulative7Days').classList.toggle('active', period === 7);
      document.getElementById('cumulative30Days').classList.toggle('active', period === 30);
      
      // Update table
      updateCumulativeSalesTable();
    }
    
    // ====== Dead Stock Functions ======
    
    // Update dead stock table
    function updateDeadStockTable() {
      const tableBody = document.getElementById('deadStockTableBody');
      
      if (!tableBody) {
        console.error('Dead stock table body element not found');
        return;
      }
      
      const deadStockData = prepareDeadStockData();
      
      if (deadStockData.length === 0) {
        showEmptyDeadStockTable();
        return;
      }
      
      populateDeadStockTable(deadStockData);
    }
    
    // Prepare dead stock data (no sales in 14+ days)
    function prepareDeadStockData() {
      const deadStock = [];
      
      if (!dashboardData.inventorySnapshot || !dashboardData.salesSnapshot || !dashboardData.products) {
        console.log('Required data not available for dead stock analysis');
        return deadStock;
      }
      
      const fourteenDaysAgo = new Date();
      fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);
      
      // Process inventory snapshot
      dashboardData.inventorySnapshot.forEach(inventory => {
        const sku = inventory.SKU;
        const currentStock = parseInt(inventory.CurrentStock) || 0;
        
        // Skip if no stock
        if (currentStock <= 0) return;
        
        // Find product info
        const product = dashboardData.products.find(p => p.SKU === sku);
        if (!product) return;
        
        // Find last sale date from sales snapshot
        const salesRecord = dashboardData.salesSnapshot.find(sale => sale.SKU === sku);
        let lastSaleDate = null;
        let daysSinceLastSale = 999; // Default to high number if no sales
        
        if (salesRecord && salesRecord.LastSoldDate) {
          try {
            lastSaleDate = new Date(salesRecord.LastSoldDate);
            if (!isNaN(lastSaleDate.getTime())) {
              const timeDiff = new Date() - lastSaleDate;
              daysSinceLastSale = Math.floor(timeDiff / (1000 * 3600 * 24));
            }
          } catch (error) {
            console.warn(`Invalid date format for SKU ${sku}:`, salesRecord.LastSoldDate);
          }
        }
        
        // Only include items with no sales in 14+ days
        if (daysSinceLastSale >= 14) {
          const price = parseFloat(product.Price) || 0;
          const stockValue = currentStock * price;
          
          deadStock.push({
            sku: sku,
            productName: product["Product Name"] || 'Unknown Product',
            currentStock: currentStock,
            daysSinceLastSale: daysSinceLastSale,
            stockValue: stockValue,
            lastSaleDate: lastSaleDate
          });
        }
      });
      
      // Sort by days since last sale (highest first) - most problematic dead stock at top
      deadStock.sort((a, b) => {
        // First sort by days since last sale (descending - most days first)
        if (a.daysSinceLastSale !== b.daysSinceLastSale) {
          return b.daysSinceLastSale - a.daysSinceLastSale;
        }
        // If same days, sort by stock value (descending - highest value first)
        return b.stockValue - a.stockValue;
      });
      
      console.log('Dead stock data prepared:', deadStock.length, 'items');
      return deadStock;
    }
    
    // Populate dead stock table
    function populateDeadStockTable(deadStockData) {
      const tableBody = document.getElementById('deadStockTableBody');
      
      if (!tableBody) {
        console.error('Dead stock table body element not found');
        return;
      }
      
      // Clear existing rows
      tableBody.innerHTML = '';
      
      // Add data rows
      deadStockData.forEach(item => {
        const row = document.createElement('tr');
        const riskClass = getDeadStockRiskClass(item.daysSinceLastSale);
        
        row.className = riskClass;
        row.innerHTML = `
          <td class="sku-column">${item.sku}</td>
          <td class="product-name-column">${item.productName}</td>
          <td class="stock-column">${item.currentStock}</td>
          <td class="days-column">${item.daysSinceLastSale}</td>
          <td class="value-column">RM${item.stockValue.toFixed(2)}</td>
        `;
        tableBody.appendChild(row);
      });
    }
    
    // Get risk class for dead stock row styling
    function getDeadStockRiskClass(daysSinceLastSale) {
      if (daysSinceLastSale >= 30) return 'high-risk';
      if (daysSinceLastSale >= 21) return 'medium-risk';
      return 'low-risk';
    }
    
    // Show empty dead stock table
    function showEmptyDeadStockTable() {
      const tableBody = document.getElementById('deadStockTableBody');
      if (tableBody) {
        tableBody.innerHTML = '<tr class="empty-row"><td colspan="5">No dead stock items found (all items have recent sales)</td></tr>';
      }
    }
    

    
    // Update Top 10 SKU Performance chart
    function updateTopSkuPerformanceChart() {
      if (!dashboardData.salesSnapshot || dashboardData.salesSnapshot.length === 0) {
        console.log('No sales data available - chart will show empty data');
        // Initialize empty chart instead of returning
      }
      
      const chartData = prepareTopSkuPerformanceData(currentTrendPeriod);
      
      if (topSkuPerformanceChart) {
        topSkuPerformanceChart.destroy();
      }
      
      const ctx = document.getElementById('topSkuPerformanceChart').getContext('2d');
      const chartContainer = document.getElementById('topSkuPerformanceChartContainer');
      
      // Check if mobile screen
      const isMobile = window.innerWidth <= 768;
      
      // Adjust chart container height on mobile for better touch interaction
      if (isMobile) {
        chartContainer.style.height = '500px'; // Increased height for mobile
        chartContainer.style.minHeight = '500px';
      } else {
        chartContainer.style.height = ''; // Reset to default on desktop
        chartContainer.style.minHeight = '';
      }
      
      topSkuPerformanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartData.labels,
                      datasets: [
            {
              label: `Last ${currentTrendPeriod} Days`,
              data: chartData.salesData,
              backgroundColor: 'rgba(59, 130, 246, 0.8)',
              borderColor: 'rgb(59, 130, 246)',
              borderWidth: 1,
              // Increase bar thickness on mobile
              ...(isMobile && {
                barThickness: 'flex',
                maxBarThickness: 50
              })
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: isMobile ? 'y' : 'x', // Horizontal bars on mobile, vertical on desktop
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: isMobile ? 'Units Sold' : 'SKU'
              },
              beginAtZero: isMobile ? true : false
            },
            y: {
              display: true,
              title: {
                display: true,
                text: isMobile ? 'SKU' : 'Units Sold'
              },
              beginAtZero: !isMobile ? true : false,
              // Increase bar thickness on mobile for better touch interaction
              ...(isMobile && {
                categoryPercentage: 0.8,
                barPercentage: 0.9
              })
            }
          },
          plugins: {
            title: {
              display: true,
              text: `Top 10 SKU Performance - Last ${currentTrendPeriod} Days`
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const sku = context.label;
                  const value = isMobile ? context.parsed.x : context.parsed.y;
                  return `${sku}: ${value} units`;
                }
              }
            }
          }
        }
      });
    }
    
    // Prepare Top 10 SKU Performance data based on period
    function prepareTopSkuPerformanceData(period) {
      const labels = [];
      const salesData = [];
      
      if (dashboardData.salesSnapshot && dashboardData.salesSnapshot.length > 0) {
        // Get the appropriate sales field based on period
        const salesField = period === 7 ? 'Last7Days' : 'Last30Days';
        
        // Filter and sort SKUs by sales performance
        const skuPerformance = dashboardData.salesSnapshot
          .filter(sale => sale[salesField] && sale[salesField] > 0) // Only SKUs with sales
          .sort((a, b) => (b[salesField] || 0) - (a[salesField] || 0)) // Sort by sales descending
          .slice(0, 10); // Take top 10
        
        // Prepare chart data
        skuPerformance.forEach(sale => {
          labels.push(sale.SKU);
          salesData.push(sale[salesField] || 0);
        });
        
        console.log(`Top 10 SKU Performance data prepared for ${period} days:`, {
          period,
          salesField,
          topPerformers: skuPerformance.map(s => ({ sku: s.SKU, sales: s[salesField] }))
        });
      } else {
        console.log('No sales data available - chart will show empty data');
      }
      
      return { labels, salesData };
    }
    
    // Switch trend period
    function switchTrendPeriod(period) {
      currentTrendPeriod = period;
      
      // Update button states
      document.getElementById('trend7Days').classList.toggle('active', period === 7);
      document.getElementById('trend30Days').classList.toggle('active', period === 30);
      
      // Update chart
      updateTopSkuPerformanceChart();
    }
    
    // ====== Global Refresh Function ======
    
    // Refresh all sections (full dashboard refresh)
    async function refreshAllSections() {
      showInfo('Refreshing all dashboard data...');
      console.log('ðŸ”„ Refreshing ALL sections...');
      
      try {
        await fetchAllDashboardData();
        showSuccess('All dashboard data refreshed successfully');
        console.log('âœ… All sections refresh complete');
      } catch (error) {
        showError(`Failed to refresh all sections: ${error.message}`);
        console.error('Error refreshing all sections:', error);
      }
    }
    
    // ====== Smart Caching Strategy ======
    
    // Each section now uses smart caching for PRODUCT DATA ONLY:
    // - Overview: Fetches fresh inventory snapshot + uses cached product data
    // - Shop Info: Fetches fresh inventory + sales snapshots + uses cached product data
    // - Warehouse: Fetches fresh inventory snapshot + uses cached product data
    // - Dead Stock: Fetches fresh inventory + sales snapshots + uses cached product data
    // 
    // NOTE: Product master data is cached globally and only refreshed via dedicated button
    // NOTE: Section refreshes ALWAYS fetch fresh snapshot data, but reuse cached product data
    
    // Smart fetch: ALWAYS fetch fresh snapshot data, but use cached product data
    async function smartFetchInventoryData() {
      console.log('ðŸ“¦ Fetching fresh inventory snapshot data...');
      try {
        const inventoryData = await fetchInventorySnapshot();
        if (inventoryData !== null) {
          dashboardData.inventorySnapshot = inventoryData;
          dashboardData.lastUpdated = new Date();
          console.log('âœ… Fresh inventory data fetched and cached');
        }
        return inventoryData;
      } catch (error) {
        console.error('Error fetching inventory data:', error);
        console.log('âš ï¸ Falling back to cached data (if any)');
        if (dashboardData.inventorySnapshot && dashboardData.inventorySnapshot.length > 0) {
          console.log('ðŸ“¦ Using fallback cached inventory data');
        } else {
          console.log('âŒ No cached inventory data available');
        }
        return dashboardData.inventorySnapshot || null;
      }
    }
    
    // Smart fetch: ALWAYS fetch fresh sales data, but use cached product data
    async function smartFetchSalesData() {
      console.log('ðŸ’° Fetching fresh sales snapshot data...');
      try {
        const salesData = await fetchSalesSnapshot();
        if (salesData !== null) {
          dashboardData.salesSnapshot = salesData;
          dashboardData.lastUpdated = new Date();
          console.log('âœ… Fresh sales data fetched and cached');
        }
        return salesData;
      } catch (error) {
        console.error('Error fetching sales data:', error);
        console.log('âš ï¸ Falling back to cached data (if any)');
        if (dashboardData.salesSnapshot && dashboardData.salesSnapshot.length > 0) {
          console.log('ðŸ’° Using fallback cached sales data');
        } else {
          console.log('âŒ No cached sales data available');
        }
        return dashboardData.salesSnapshot || null;
      }
    }
    
    // ====== Individual Section Data Fetching (Smart Caching) ======
    
    // Each section now fetches FRESH snapshot data + uses cached product data:
    // - Overview: Fetches fresh inventory snapshot + uses cached product data
    // - Shop Info: Fetches fresh inventory + sales snapshots + uses cached product data
    // - Warehouse: Fetches fresh inventory snapshot + uses cached product data
    // - Dead Stock: Fetches fresh inventory + sales snapshots + uses cached product data
    // 
    // NOTE: Product master data is cached globally and only refreshed via dedicated button
    // NOTE: Section refreshes ALWAYS get fresh snapshot data, but reuse cached product data
    
    // Fetch overview section data (uses smart caching)
    async function fetchOverviewData() {
      return await smartFetchInventoryData();
    }
    
    // Fetch only shop information data (inventory snapshot for shop + sales snapshot)
    // Fetch shop information data (uses smart caching)
    async function fetchShopInfoData() {
      const [inventoryData, salesData] = await Promise.all([
        smartFetchInventoryData(),
        smartFetchSalesData()
      ]);
      
      return { inventoryData, salesData };
    }
    
    // Fetch warehouse data (uses smart caching)
    async function fetchWarehouseData() {
      return await smartFetchInventoryData();
    }
    
    // Fetch dead stock data (uses smart caching)
    async function fetchDeadStockData() {
      const [inventoryData, salesData] = await Promise.all([
        smartFetchInventoryData(),
        smartFetchSalesData()
      ]);
      
      return { inventoryData, salesData };
    }
    
    // ====== Section-Specific Refresh Functions ======
    
    // IMPORTANT: Each refresh button now fetches FRESH snapshot data + uses cached product data
    // - Overview: Fetches fresh inventory snapshot + uses cached product data
    // - Shop Info: Fetches fresh inventory + sales snapshots + uses cached product data
    // - Warehouse: Fetches fresh inventory snapshot + uses cached product data
    // - Dead Stock: Fetches fresh inventory + sales snapshots + uses cached product data
    // 
    // Product master data is cached globally and only refreshed via dedicated button above
    // This gives you fresh data while avoiding expensive product master API calls
    
    // Refresh overview data only
    async function refreshOverviewData() {
      showInfo('Refreshing overview data...');
      console.log('ðŸ”„ Refreshing Overview section only...');
      await fetchOverviewData();
      calculateOverviewKPIs();
      showSuccess('Overview data refreshed');
      console.log('âœ… Overview section refresh complete');
    }
    
    // Refresh shop information data only
    async function refreshShopInfo() {
      showInfo('Refreshing shop information...');
      console.log('ðŸ”„ Refreshing Shop Information section only...');
      await fetchShopInfoData();
      updateTopSellingChart();
      updateCumulativeSalesTable();
      updateInventoryAlertsTable();
      showSuccess('Shop information refreshed');
      console.log('âœ… Shop Information section refresh complete');
    }
    
    // Refresh warehouse data only
    async function refreshWarehouseData() {
      showInfo('Refreshing warehouse data...');
      console.log('ðŸ”„ Refreshing Warehouse section only...');
      await fetchWarehouseData();
      updateWarehouseInventoryTable();
      showSuccess('Warehouse data refreshed');
      console.log('âœ… Warehouse section refresh complete');
    }
    
    // Refresh dead stock data only
    async function refreshDeadStockData() {
      showInfo('Refreshing dead stock data...');
      console.log('ðŸ”„ Refreshing Dead Stock section only...');
      await fetchDeadStockData();
      updateDeadStockTable();
      showSuccess('Dead stock data refreshed');
      console.log('âœ… Dead Stock section refresh complete');
    }

    // ====== Theme Toggle System ======
    
    // Toggle between light and dark themes
    function toggleTheme() {
      const body = document.body;
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      const themeText = document.getElementById('themeText');
      
      if (body.getAttribute('data-theme') === 'dark') {
        // Switch to light theme
        body.setAttribute('data-theme', 'light');
        themeIcon.className = 'icon icon-dark-mode';
        themeText.textContent = 'Dark Mode';
        localStorage.setItem('theme', 'light');
        showInfo('Switched to Light Mode');
      } else {
        // Switch to dark theme
        body.setAttribute('data-theme', 'dark');
        themeIcon.className = 'icon icon-lightbulb';
        themeText.textContent = 'Light Mode';
        localStorage.setItem('theme', 'dark');
        showInfo('Switched to Dark Mode');
      }
    }
    
    // Initialize theme from localStorage or default to dark
    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      const body = document.body;
      const themeIcon = document.getElementById('themeIcon');
      const themeText = document.getElementById('themeText');
      
      body.setAttribute('data-theme', savedTheme);
      
      if (savedTheme === 'light') {
        themeIcon.className = 'icon icon-dark-mode';
        themeText.textContent = 'Dark Mode';
      } else {
        themeIcon.className = 'icon icon-lightbulb';
        themeText.textContent = 'Light Mode';
      }
    }

    // Handle window resize for responsive charts
    function handleWindowResize() {
      // Debounce resize events
      clearTimeout(window.resizeTimeout);
      window.resizeTimeout = setTimeout(() => {
        if (topSkuPerformanceChart) {
          updateTopSkuPerformanceChart();
        }
      }, 250);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      initializeTheme(); // Initialize theme first
      
      // Add resize listener for responsive charts
      window.addEventListener('resize', handleWindowResize);
      
      // Test API connection on page load
      testAPIConnection().then(results => {
        if (results) {
          // Load dashboard data if connection is successful
          fetchAllDashboardData();
        }
      });
      
      // Initialize charts with empty state
      setTimeout(() => {
        const topSellingSection = document.querySelector('#topSellingChart')?.closest('.chart-section');
        
        if (topSellingSection) topSellingSection.classList.add('empty');
      }, 100);
    });
  </script>
</body>
</html>
