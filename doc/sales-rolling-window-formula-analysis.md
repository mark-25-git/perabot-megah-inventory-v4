# Sales Rolling Window Formula Analysis Report
 
**Task:** Analyze and implement Google Sheets formulas for Last7Days and Last30Days calculations  
**Status:** Analysis Phase  

---

## ðŸ“‹ **Sheet Structure Reference**

### **Inventory Log Sheet**
- **Sheet Name:** `"Inventory Log"`
- **Purpose:** Logs all inventory transactions
- **Columns (in order):**
  1. `TransactionID` (Column A) - Unique identifier for each transaction
  2. `Timestamp` (Column B) - Date and time of transaction (DD/MM/YYYY HH:MM:SS format)
  3. `SKU` (Column C) - Product SKU identifier
  4. `Quantity` (Column D) - Quantity change (positive for increase, negative for decrease)
  5. `Mode` (Column E) - Transaction type (RECEIVING, SALE, TRANSFER, ADJUSTMENT)
  6. `SourceLocation` (Column F) - Source location (Shop, Warehouse)
  7. `DestinationLocation` (Column G) - Destination location (Shop, Warehouse)
  8. `User` (Column H) - User who performed the transaction
  9. `Notes` (Column I) - Additional notes or comments

### **Sales Snapshot Sheet**
- **Sheet Name:** `"Sales Snapshot"`
- **Purpose:** Provides real-time snapshot of sales data with calculated values
- **Columns (in order):**
  1. `SnapshotID` (Column A) - Unique identifier (typically same as SKU)
  2. `SKU` (Column B) - Product SKU identifier
  3. `TotalSold` (Column C) - Cumulative total units sold
  4. `Last7Days` (Column D) - **TARGET:** Units sold in last 7 days
  5. `Last30Days` (Column E) - **TARGET:** Units sold in last 30 days
  6. `LastSoldDate` (Column F) - Date of most recent sale
  7. `LastUpdated` (Column G) - Last update timestamp
  8. `TodaySales` (Column H) - Units sold today only
  9. `CumulativeValue` (Column I) - Total sales value (TotalSold Ã— Price)
  10. `TopSellerRank` (Column J) - Ranking based on sales performance

### **Product Master Sheet**
- **Sheet Name:** `"Product Master"`
- **Purpose:** Stores master product information including pricing
- **Key Columns:**
  - `SKU` - Product SKU identifier
  - `Price` - Unit price for calculations

---

## ðŸŽ¯ **Current Problem Statement**

### **Issue Identified:**
- Last7Days and Last30Days columns in Sales Snapshot show identical values
- Expected behavior: Last30Days should be â‰¥ Last7Days (30-day window includes 7-day window)
- Root cause: Date comparison logic in Google Apps Script is failing due to string vs Date object comparison

### **Current Implementation:**
- Calculations performed in Google Apps Script via `calculateRollingWindowSales()` function
- Date parsing issue: `log["Timestamp"]` returns string, not Date object
- Comparison `saleDate >= sevenDaysAgo` fails due to type mismatch

---

## ðŸ“Š **Data Format Specifications**

### **Timestamp Format:**
- **Format:** `DD/MM/YYYY HH:MM:SS`
- **Example:** `26/08/2025 15:42:12`
- **Source:** Generated by `formatDateForSheet()` function in Code.gs

### **Sales Filter Criteria:**
- **Mode:** Must equal `"SALE"`
- **SourceLocation:** Must equal `"Shop"`
- **SKU:** Must match the target SKU being calculated
- **Quantity:** Use absolute value (always positive for sales)

### **Date Range Logic:**
- **Last7Days:** Sales from `TODAY() - 7 days` to `TODAY()`
- **Last30Days:** Sales from `TODAY() - 30 days` to `TODAY()`
- **Inclusive:** Both ranges include sales from exactly 7/30 days ago

---

## ðŸ”„ **Proposed Solution: Dynamic Formula Auto-Fill**

### **Core Strategy:**
- **Hybrid Approach:** GAS handles data entry, formulas handle calculations
- **Smart Processing:** Skip rows with existing formulas to reduce workload
- **Auto-Migration:** New SKUs automatically get formula-based calculations
- **Backward Compatibility:** Existing data remains unchanged during migration

### **Flow Description (Plain Terms):**

#### **Step 1: New Sale Comes In**
- Customer makes a purchase
- GAS needs to update the Sales Snapshot

#### **Step 2: Check Each SKU Row**
- **Has Formula?** â†’ Skip it! (Formula will update itself automatically)
- **No Formula?** â†’ Calculate with GAS (traditional method)

#### **Step 3: For New SKUs**
- Create new row in Sales Snapshot
- **Automatically insert formulas** for Last7Days and Last30Days columns
- No GAS calculation needed for these columns

#### **Step 4: Result**
- **Existing rows with formulas:** Update automatically (zero GAS workload)
- **New rows:** Get formulas immediately upon creation
- **Old rows without formulas:** Continue using GAS until manually converted

### **Performance Benefits:**

#### **Before (Current System):**
- 100 SKUs in Sales Snapshot
- Every sale = GAS recalculates all 100 rows
- Takes ~30 seconds, uses significant API quota

#### **After (Smart Processing):**
- 100 SKUs in Sales Snapshot
- 80 have formulas, 20 don't
- Every sale = GAS only recalculates 20 rows
- Takes ~6 seconds, uses minimal quota

#### **After Full Migration:**
- 100 SKUs in Sales Snapshot
- All 100 have formulas
- Every sale = GAS does almost nothing
- Takes ~1 second, uses almost no quota

### **Implementation Strategy:**

#### **Phase 1: Add Formula Auto-Fill Logic**
- Modify `updateSalesSnapshot()` function
- Add formula detection: `hasFormula(sheet, row, col)`
- Auto-insert formulas for new SKUs only

#### **Phase 2: Smart Processing Logic**
- Skip rows with existing formulas
- Only process rows that need GAS calculations
- Gradual workload reduction as more SKUs get formulas

#### **Phase 3: Full Migration (Optional)**
- Convert all existing static values to formulas
- Remove GAS calculation code for Last7Days/Last30Days
- Achieve maximum performance

### **Key Functions Implemented:**

```javascript
// Check if cell contains formula
function hasFormula(sheet, row, col) {
  try {
    var cell = sheet.getRange(row, col);
    var formula = cell.getFormula();
    return formula.startsWith('=');
  } catch (error) {
    addLog("Error checking formula in cell " + row + "," + col + ": " + error.toString());
    return false;
  }
}

// Create Last7Days formula for a specific SKU
function createLast7DaysFormula(sku) {
  return '=SUMIFS(\'Inventory Log\'!D:D, \'Inventory Log\'!E:E, "SALE", \'Inventory Log\'!F:F, "Shop", \'Inventory Log\'!C:C, "' + sku + '", \'Inventory Log\'!B:B, ">="&TODAY()-7)';
}

// Create Last30Days formula for a specific SKU
function createLast30DaysFormula(sku) {
  return '=SUMIFS(\'Inventory Log\'!D:D, \'Inventory Log\'!E:E, "SALE", \'Inventory Log\'!F:F, "Shop", \'Inventory Log\'!C:C, "' + sku + '", \'Inventory Log\'!B:B, ">="&TODAY()-30)';
}

// Auto-fill formulas for Last7Days and Last30Days columns
function autoFillFormulas(sku, rowIndex) {
  if (!salesSnapshotSheet) {
    addLog("ERROR: Sales Snapshot sheet not found for auto-fill");
    return;
  }
  
  try {
    var last7DaysCol = 4; // Column D
    var last30DaysCol = 5; // Column E
    
    // Only insert Last7Days formula if no formula exists
    if (!hasFormula(salesSnapshotSheet, rowIndex, last7DaysCol)) {
      var last7DaysFormula = createLast7DaysFormula(sku);
      salesSnapshotSheet.getRange(rowIndex, last7DaysCol).setFormula(last7DaysFormula);
      addLog("Inserted Last7Days formula for SKU: " + sku);
    }
    
    // Only insert Last30Days formula if no formula exists
    if (!hasFormula(salesSnapshotSheet, rowIndex, last30DaysCol)) {
      var last30DaysFormula = createLast30DaysFormula(sku);
      salesSnapshotSheet.getRange(rowIndex, last30DaysCol).setFormula(last30DaysFormula);
      addLog("Inserted Last30Days formula for SKU: " + sku);
    }
    
  } catch (error) {
    addLog("Error auto-filling formulas for SKU " + sku + ": " + error.toString());
  }
}

// Check if a row needs formula processing
function needsFormulaProcessing(sku, rowIndex) {
  if (!salesSnapshotSheet) {
    return true; // Fall back to GAS processing if sheet not found
  }
  
  try {
    var last7DaysCol = 4; // Column D
    var last30DaysCol = 5; // Column E
    
    // If both columns have formulas, skip GAS processing
    if (hasFormula(salesSnapshotSheet, rowIndex, last7DaysCol) && 
        hasFormula(salesSnapshotSheet, rowIndex, last30DaysCol)) {
      addLog("SKU " + sku + " has formulas, skipping GAS processing");
      return false;
    }
    
    addLog("SKU " + sku + " needs GAS processing (no formulas found)");
    return true;
    
  } catch (error) {
    addLog("Error checking formula status for SKU " + sku + ": " + error.toString());
    return true; // Fall back to GAS processing on error
  }
}
```

### **Benefits:**
- **Massive Performance Improvement:** Workload reduces as more SKUs get formulas
- **Zero Data Loss:** Existing data remains unchanged
- **Future-Proof:** New SKUs automatically get optimal performance
- **Gradual Migration:** No big-bang changes required
- **Maintenance Friendly:** Formulas are self-updating and easier to debug

---

## âœ… **Implementation Status**

### **Completed:**
- âœ… **Helper Functions:** Added `hasFormula()`, `createLast7DaysFormula()`, `createLast30DaysFormula()`, `createCumulativeValueFormula()`, `autoFillFormulas()`, `needsFormulaProcessing()`
- âœ… **Formula-Only Processing:** All rolling window calculations and CumulativeValue now use formulas exclusively
- âœ… **Legacy Function Removed:** Eliminated `calculateRollingWindowSalesLegacy()` function
- âœ… **Auto-Fill Integration:** New SKUs automatically get formulas inserted for Last7Days, Last30Days, and CumulativeValue
- âœ… **Existing Row Support:** Existing rows without formulas get auto-filled when updated
- âœ… **Error Handling:** Comprehensive error handling and logging throughout

### **Key Changes Made:**
1. **Removed Legacy Function:** Eliminated `calculateRollingWindowSalesLegacy()` completely
2. **Added Formula Detection:** `hasFormula()` checks if cells contain formulas
3. **Formula-Only Processing:** All rolling window calculations and CumulativeValue now use formulas exclusively
4. **Auto-Fill Logic:** New and existing rows get formulas automatically for Last7Days, Last30Days, and CumulativeValue
5. **Simplified Logic:** Removed complex GAS calculation logic for rolling windows and CumulativeValue
6. **CumulativeValue Formula:** Added `=VLOOKUP(B2, 'Product Master'!B:E, 4, FALSE) * C2` formula
7. **Last7DaysSales Formula:** Added `=IFERROR(VLOOKUP("SKU", 'Sales Snapshot'!B:D, 3, FALSE), 0)` formula
8. **Updated GAS Functions:** Modified `updateSalesCalculatedColumns()` to only handle TopSellerRank
9. **New Row Process:** New rows get temporary `0` values that are immediately replaced with formulas
10. **Cross-Sheet Lookup:** Inventory Snapshot now looks up Last7Days from Sales Snapshot

### **How It Works:**
1. **New Sales Come In:** GAS processes the sales update
2. **Check Each SKU:** `needsFormulaProcessing()` determines if formulas exist for Last7Days, Last30Days, and CumulativeValue
3. **Formula Processing:** 
   - **Has All Formulas:** Skip processing (formulas update automatically)
   - **Missing Formulas:** Auto-fill formulas for Last7Days, Last30Days, and CumulativeValue
4. **Auto-Fill:** `autoFillFormulas()` and `autoFillInventoryFormulas()` insert formulas:
   - **Last7Days:** `=SUMIFS('Inventory Log'!D:D, 'Inventory Log'!E:E, "SALE", 'Inventory Log'!F:F, "Shop", 'Inventory Log'!C:C, "SKU", 'Inventory Log'!B:B, ">="&TODAY()-7)`
   - **Last30Days:** `=SUMIFS('Inventory Log'!D:D, 'Inventory Log'!E:E, "SALE", 'Inventory Log'!F:F, "Shop", 'Inventory Log'!C:C, "SKU", 'Inventory Log'!B:B, ">="&TODAY()-30)`
   - **CumulativeValue:** `=VLOOKUP(B2, 'Product Master'!B:E, 4, FALSE) * C2`
   - **Last7DaysSales:** `=IFERROR(VLOOKUP("SKU", 'Sales Snapshot'!B:D, 3, FALSE), 0)`
5. **Result:** All rolling window calculations, CumulativeValue, and cross-sheet lookups use formulas exclusively

### **CumulativeValue Implementation Details:**

**Formula:** `=VLOOKUP(B2, 'Product Master'!B:E, 4, FALSE) * C2`

**Formula Breakdown:**
- **VLOOKUP(B2, 'Product Master'!B:E, 4, FALSE):** Looks up the SKU (column B) in Product Master sheet, returns the Price (column 4)
- **C2:** References the TotalSold value in the same row
- **Result:** Price Ã— TotalSold = CumulativeValue

**New Row Creation Process:**
1. **Temporary Placeholder:** New rows are created with `0` for CumulativeValue
2. **Row Appended:** The row is added to the Sales Snapshot sheet
3. **Formula Inserted:** `autoFillFormulas()` immediately replaces the `0` with the VLOOKUP formula
4. **Real-time Calculation:** Formula calculates the actual cumulative value automatically

**Benefits:**
- **No GAS Calculation:** Eliminates complex GAS logic for CumulativeValue
- **Real-time Updates:** Formula updates automatically when TotalSold or Product Master prices change
- **Consistent Approach:** All calculated columns now use formulas
- **Better Performance:** Reduces GAS execution time and complexity

### **Last7DaysSales Implementation Details:**

**Formula:** `=IFERROR(VLOOKUP("SKU", 'Sales Snapshot'!B:D, 3, FALSE), 0)`

**Formula Breakdown:**
- **VLOOKUP("SKU", 'Sales Snapshot'!B:D, 3, FALSE):** Looks up the SKU in Sales Snapshot, returns Last7Days (column 3)
- **IFERROR(..., 0):** Returns 0 if SKU not found in Sales Snapshot
- **Result:** Last7Days value from Sales Snapshot for the same SKU

**Cross-Sheet Integration:**
- **Inventory Snapshot** looks up data from **Sales Snapshot**
- **Real-time Sync:** When Sales Snapshot Last7Days updates, Inventory Snapshot Last7DaysSales updates automatically
- **No Duplication:** Eliminates duplicate GAS calculations for the same data

**Benefits:**
- **Single Source of Truth:** Last7Days calculated once in Sales Snapshot
- **Automatic Sync:** Inventory Snapshot stays in sync with Sales Snapshot
- **Reduced GAS Load:** No need to recalculate Last7Days for Inventory Snapshot
- **Data Consistency:** Both sheets always show the same Last7Days value

### **Current System State:**

**Formula-Based Columns:**
- âœ… **Last7Days:** Uses SUMIFS formula for rolling 7-day sales
- âœ… **Last30Days:** Uses SUMIFS formula for rolling 30-day sales  
- âœ… **CumulativeValue:** Uses VLOOKUP formula for price Ã— quantity calculation
- âœ… **Last7DaysSales (Inventory):** Uses VLOOKUP formula to lookup Last7Days from Sales Snapshot

**GAS-Only Columns:**
- âœ… **TopSellerRank:** Still calculated in GAS (requires global ranking across all SKUs)

**Hybrid Approach:**
- **Data Entry:** GAS handles all inventory log processing and snapshot updates
- **Calculations:** Formulas handle real-time calculations for rolling windows and cumulative values
- **Ranking:** GAS handles complex ranking logic that requires global data access

### **Testing Required:**
- [ ] Test with existing SKUs (should skip GAS processing if formulas exist)
- [ ] Test with new SKUs (should get formulas auto-inserted)
- [ ] Test with mixed scenarios (some SKUs with formulas, some without)
- [ ] Verify formula accuracy matches GAS calculations
- [ ] Test performance improvement with large datasets
- [ ] Verify CumulativeValue formula updates when Product Master prices change
- [ ] Test TopSellerRank calculation still works correctly

---

*Implementation completed. Ready for testing and validation.*
